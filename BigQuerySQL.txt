#standardSQL
WITH usage_sample AS (
 SELECT
   -- scalar IDs and times
   collection_id,
   instance_index,
   machine_id,
   start_time,
   end_time,


   -- flatten average_usage & maximum_usage
   average_usage.cpus   AS avg_cpus,
   average_usage.memory AS avg_memory,
   maximum_usage.cpus   AS max_cpus,
   maximum_usage.memory AS max_memory,


   -- scalar usage fields
   assigned_memory,
   page_cache_memory,
   cycles_per_instruction,
   memory_accesses_per_instruction,
   sample_rate,


   -- stringify nested histograms for CSV
   TO_JSON_STRING(cpu_usage_distribution)      AS cpu_usage_distribution_json,
   TO_JSON_STRING(tail_cpu_usage_distribution) AS tail_cpu_usage_distribution_json
 FROM
   `google.com:google-cluster-data.clusterdata_2019_a.instance_usage` AS u
 LIMIT 200000
)


SELECT
 u.*,


 -- All instance_events for this specific instance as JSON array (STRING)
 (
   SELECT TO_JSON_STRING(ARRAY_AGG(e))
   FROM `google.com:google-cluster-data.clusterdata_2019_a.instance_events` AS e
   WHERE e.collection_id  = u.collection_id
     AND e.instance_index = u.instance_index
     AND e.machine_id     = u.machine_id
 ) AS instance_events_json,


 -- All collection_events for this job as JSON array (STRING)
 (
   SELECT TO_JSON_STRING(ARRAY_AGG(c))
   FROM `google.com:google-cluster-data.clusterdata_2019_a.collection_events` AS c
   WHERE c.collection_id = u.collection_id
 ) AS collection_events_json


FROM
 usage_sample AS u
LIMIT 90000;



