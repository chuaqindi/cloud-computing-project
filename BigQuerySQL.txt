#standardSQL
WITH usage_sample AS (
SELECT
-- Scalar IDs and times (Needed for joins/sorting)
collection_id,
instance_index,
machine_id,
start_time,
end_time,


maximum_usage.memory AS max_memory_raw,
maximum_usage.cpus AS max_cpus_raw,
average_usage.memory AS avg_memory_raw,
average_usage.cpus AS avg_cpus_raw,


assigned_memory,
page_cache_memory,
cycles_per_instruction,
memory_accesses_per_instruction,
sample_rate


FROM
`google.com:google-cluster-data.clusterdata_2019_a.instance_usage` AS u
LIMIT 1000000  -- Increased initial sample size to get better diversity
)


SELECT
u.* EXCEPT (max_memory_raw, max_cpus_raw, avg_memory_raw, avg_cpus_raw),




max_memory_raw AS max_memory,
avg_cpus_raw AS avg_cpus,
avg_memory_raw AS avg_memory,
max_cpus_raw AS max_cpus,




-- All instance_events for this specific instance as JSON array (CRITICAL for parsing scheduler inputs)
(
SELECT TO_JSON_STRING(ARRAY_AGG(e))
FROM `google.com:google-cluster-data.clusterdata_2019_a.instance_events` AS e
WHERE e.collection_id = u.collection_id
AND e.instance_index = u.instance_index
AND e.machine_id = u.machine_id
) AS instance_events_json,




-- All collection_events for this job as JSON array (CRITICAL for parsing scheduler inputs)
(
SELECT TO_JSON_STRING(ARRAY_AGG(c))
FROM `google.com:google-cluster-data.clusterdata_2019_a.collection_events` AS c
WHERE c.collection_id = u.collection_id
) AS collection_events_json




FROM
usage_sample AS u
LIMIT 500000; -- Increased final output limit to address sample bias

